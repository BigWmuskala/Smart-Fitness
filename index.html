<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš¡ Smart-Fitness AI âš¡</title>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>

    <style>
        :root { --neon:#00f2ff; --pink:#ff007f; --bg:#0a0a0c; --card:#16161a; }
        body { font-family: Orbitron, sans-serif; background:var(--bg); color:white; margin:0; }
        .app-container { min-height:100vh; display:flex; justify-content:center; align-items:center; padding:20px; }
        .glass-card { background:var(--card); border:2px solid var(--neon); box-shadow:0 0 20px rgba(0,242,255,.3); border-radius:20px; padding:25px; width:100%; max-width:450px; text-align:center; }
        h1 { color:var(--neon); letter-spacing:3px; text-shadow:0 0 10px var(--neon); }

        .stats-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:20px 0; }
        .stat-item { background:rgba(255,255,255,.05); padding:15px; border-radius:10px; border-bottom:3px solid var(--neon); }
        .stat-value { font-size:28px; font-weight:bold; transition:.15s; }

        button {
            width:100%; margin-top:12px; padding:14px;
            background:linear-gradient(45deg,var(--neon),#0066ff);
            color:white; border:none; border-radius:10px;
            font-weight:bold; cursor:pointer;
        }
        button:hover { box-shadow:0 0 15px var(--neon); }

        #video-box { display:none; border:3px solid var(--neon); border-radius:15px; overflow:hidden; }
        canvas { width:100%; transform:scaleX(-1); }

        .step { display:none; }
        .step.active { display:block; }
    </style>
</head>

<body>
<div class="app-container">
<div class="glass-card">

<h1>CYBER-PUMP</h1>

<div id="setup">
    <div class="step active" id="s1">
        <p>Kies oefening</p>
        <button onclick="setEx('squat')">SQUATS</button>
        <button onclick="setEx('pushup')">PUSHUPS</button>
    </div>
    <div class="step" id="s2">
        <p>Kies niveau</p>
        <button onclick="startWorkout(10)">10 REPS</button>
        <button onclick="startWorkout(20)">20 REPS</button>
    </div>
</div>

<div id="workout" style="display:none;">
    <h2 id="ex-name"></h2>

    <div class="stats-grid">
        <div class="stat-item">SET<br><span id="set-val" class="stat-value">1/3</span></div>
        <div class="stat-item">REPS<br><span id="rep-val" class="stat-value">0</span></div>
    </div>

    <div id="video-box">
        <canvas id="canvas"></canvas>
    </div>

    <p id="status-msg">Camera ladenâ€¦</p>
</div>

</div>
</div>

<script>
/* ===== MODEL LINKS ===== */
const LINKS = {
    squat: "JOUW_SQUAT_LINK/",
    pushup: "JOUW_PUSHUP_LINK/"
};

/* ===== STATE ===== */
let model, webcam, ctx;
let gekozenOefening = "";
let teller = 0, doel = 0;
let set = 1, maxSets = 3;
let status = "up";

/* ===== PRO REP COUNTING ===== */
let lastRepTime = 0;
const REP_COOLDOWN = 700;
let buffer = [];
const BUFFER_SIZE = 5;

/* ===== UI ===== */
function setEx(ex) {
    gekozenOefening = ex;
    document.getElementById('s1').classList.remove('active');
    document.getElementById('s2').classList.add('active');
}

function smooth(v) {
    buffer.push(v);
    if (buffer.length > BUFFER_SIZE) buffer.shift();
    return buffer.reduce((a,b)=>a+b,0) / buffer.length;
}

function pulse() {
    const el = document.getElementById('rep-val');
    el.style.transform = "scale(1.3)";
    setTimeout(()=>el.style.transform="scale(1)",150);
}

/* ===== START ===== */
async function startWorkout(reps) {
    doel = reps;
    document.getElementById('setup').style.display="none";
    document.getElementById('workout').style.display="block";
    document.getElementById('ex-name').innerText = gekozenOefening.toUpperCase();

    model = await tmPose.load(
        LINKS[gekozenOefening]+"model.json",
        LINKS[gekozenOefening]+"metadata.json"
    );

    webcam = new tmPose.Webcam(300,300,true);
    await webcam.setup();
    await webcam.play();

    const canvas = document.getElementById("canvas");
    canvas.width = 300; canvas.height = 300;
    ctx = canvas.getContext("2d");

    document.getElementById('video-box').style.display="block";
    document.getElementById('status-msg').innerText="GO!";

    requestAnimationFrame(loop);
}

async function loop() {
    webcam.update();
    await predict();
    requestAnimationFrame(loop);
}

/* ===== AI LOGIC ===== */
async function predict() {
    const { posenetOutput } = await model.estimatePose(webcam.canvas);
    const p = await model.predict(posenetOutput);

    const up = smooth(p[0].probability);
    const down = smooth(p[1].probability);
    const now = Date.now();

    if (down > 0.85 && status === "up") status = "down";

    if (up > 0.85 && status === "down" && now-lastRepTime>REP_COOLDOWN) {
        status = "up";
        lastRepTime = now;
        teller++;
        pulse();
        document.getElementById('rep-val').innerText = teller;

        if (teller >= doel) {
            teller = 0;
            set++;
            if (set > maxSets) {
                alert("MISSIE VOLBRACHT ðŸ’ª");
                location.reload();
            }
            document.getElementById('set-val').innerText = `${set}/${maxSets}`;
        }
    }

    ctx.drawImage(webcam.canvas,0,0);
}
</script>
</body>
</html>
