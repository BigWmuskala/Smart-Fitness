<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartFitness Premium AI</title>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>

    <style>
        :root { --primary: #00e0ff; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --accent: #3b82f6; }
        body { margin: 0; font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color: var(--text); -webkit-font-smoothing: antialiased; }
        
        .app { max-width: 500px; margin: auto; min-height: 100vh; display: flex; flex-direction: column; padding-bottom: 90px; }
        .header { padding: 40px 20px 10px; font-size: 28px; font-weight: 800; letter-spacing: -0.5px; }
        .card { background: var(--card); margin: 12px 16px; padding: 24px; border-radius: 28px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2); }
        
        /* Input styling */
        input[type="number"], select { 
            width: 100%; padding: 15px; margin: 15px 0; border-radius: 12px; border: 2px solid #334155; 
            background: #0f172a; color: white; font-size: 16px; box-sizing: border-box;
        }

        .button { 
            width: 100%; padding: 18px; margin-top: 10px; border: none; border-radius: 20px; 
            background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; 
            font-weight: 700; font-size: 16px; cursor: pointer; transition: 0.2s; 
        }
        .button:active { transform: scale(0.96); }

        .progress-container { height: 6px; background: #334155; margin: 10px 20px; border-radius: 10px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: 0.5s; }

        .bottom-nav { position: fixed; bottom: 0; width: 100%; max-width: 500px; display: flex; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); border-top: 1px solid #1e293b; padding: 10px 0 25px; }
        .nav-item { flex: 1; text-align: center; color: #64748b; font-size: 12px; font-weight: 600; cursor: pointer; }
        .nav-item.active { color: var(--primary); }

        #repCounter { font-size: 80px; font-weight: 900; color: var(--primary); text-align: center; }
        .canvas-wrapper { width: 100%; border-radius: 24px; overflow: hidden; border: 2px solid #334155; background: #000; }
        canvas { width: 100%; transform: scaleX(-1); }
        
        .hidden { display: none; }
        .feedback { color: var(--primary); font-weight: bold; margin-bottom: 15px; display: block; }
    </style>
</head>

<body>

<div class="app">
    <div id="onboarding">
        <div class="header">Welkom Coach ‚ö°</div>
        <div class="progress-container"><div class="progress-bar" id="pBar"></div></div>
        <div class="card" id="questionCard">
            </div>
    </div>

    <div id="home" class="hidden">
        <div class="header">Mijn Dashboard</div>
        <div class="card">
            <h3 id="dashGreeting" style="margin-top:0">Lekker bezig!</h3>
            <div id="dashStats" style="color: #94a3b8; font-size: 14px; line-height: 1.6;"></div>
        </div>
        <div class="card" id="startActionCard">
            </div>
    </div>

    <div id="workoutScreen" class="hidden">
        <div class="header" id="exerciseTitle">Training</div>
        <div class="card">
            <div id="repCounter">0</div>
            <div id="status-msg" style="text-align: center; color: #94a3b8; margin-bottom: 15px;">AI detectie start...</div>
            <div class="canvas-wrapper"><canvas id="canvas"></canvas></div>
            <button class="button" style="background: #ef4444; margin-top: 25px;" onclick="stopWorkout()">Stop Sessie</button>
        </div>
    </div>

    <div id="history" class="hidden">
        <div class="header">Mijn Progressie</div>
        <div id="historyList"></div>
        <button class="button" style="background: #334155; margin: 20px; width: calc(100% - 40px);" onclick="resetUser()">Reset Gegevens</button>
    </div>
</div>

<div class="bottom-nav" id="mainNav" style="display:none;">
    <div class="nav-item active" id="nav-home" onclick="switchTab('home')">üè†<br>Home</div>
    <div class="nav-item" id="nav-history" onclick="switchTab('history')">üìä<br>Stats</div>
</div>

<script>
const LINKS = {
    legs: "https://teachablemachine.withgoogle.com/models/VyHCtMsZf/",
    chest: "https://teachablemachine.withgoogle.com/models/Nv8j7aUsi/"
};

let userData = { age: null, height: null, time: null, goal: null };
let currentStep = 1;
let model, webcam, ctx, animationId;
let reps = 0, status = "up";

init();

function init() {
    const saved = localStorage.getItem("fitnessUserPro");
    if (saved) {
        userData = JSON.parse(saved);
        showHome();
    } else {
        renderStep();
    }
}

function renderStep() {
    const container = document.getElementById("questionCard");
    const pBar = document.getElementById("pBar");
    pBar.style.width = (currentStep / 4 * 100) + "%";

    if (currentStep === 1) {
        container.innerHTML = `
            <h3>Wat is je leeftijd?</h3>
            <input type="number" id="ageInput" placeholder="Bijv. 16">
            <button class="button" onclick="saveAge()">Volgende</button>
        `;
    } else if (currentStep === 2) {
        container.innerHTML = `
            <span class="feedback">Perfecte leeftijd om te sporten!</span>
            <h3>Wat is je lengte (cm)?</h3>
            <input type="number" id="heightInput" placeholder="Bijv. 175">
            <button class="button" onclick="saveHeight()">Volgende</button>
        `;
    } else if (currentStep === 3) {
        container.innerHTML = `
            <h3>Hoeveel tijd per week?</h3>
            <select id="timeSelect">
                <option value="1-2">1-2 uur</option>
                <option value="3-5">3-5 uur</option>
                <option value="5+">5+ uur</option>
            </select>
            <button class="button" onclick="saveTime()">Volgende</button>
        `;
    } else if (currentStep === 4) {
        container.innerHTML = `
            <h3>Waar wil je op focussen?</h3>
            <button class="button" onclick="saveGoal('legs')">Benen (Squats)</button>
            <button class="button" onclick="saveGoal('chest')" style="margin-top:10px">Borst (Push-ups)</button>
        `;
    }
}

function saveAge() { 
    userData.age = document.getElementById("ageInput").value; 
    if(userData.age) { currentStep = 2; renderStep(); }
}
function saveHeight() { 
    userData.height = document.getElementById("heightInput").value; 
    if(userData.height) { currentStep = 3; renderStep(); }
}
function saveTime() { 
    userData.time = document.getElementById("timeSelect").value; 
    currentStep = 4; renderStep(); 
}
function saveGoal(goal) { 
    userData.goal = goal; 
    localStorage.setItem("fitnessUserPro", JSON.stringify(userData));
    showHome(); 
}

function showHome() {
    document.getElementById("onboarding").classList.add("hidden");
    document.getElementById("home").classList.remove("hidden");
    document.getElementById("mainNav").style.display = "flex";
    
    document.getElementById("dashStats").innerHTML = `
        Lengte: ${userData.height} cm | Leeftijd: ${userData.age}<br>
        Planning: ${userData.time} uur per week
    `;

    const goalName = userData.goal === 'legs' ? "Benen (Squats)" : "Borst (Push-ups)";
    document.getElementById("startActionCard").innerHTML = `
        <h3 style="margin-top:0">Klaar voor actie?</h3>
        <p>Focus van vandaag: <b>${goalName}</b></p>
        <button class="button" onclick="startWorkout()">START WORKOUT</button>
    `;
}

function switchTab(tab) {
    document.querySelectorAll(".nav-item").forEach(n => n.classList.remove("active"));
    document.getElementById('nav-' + tab).classList.add('active');
    document.getElementById("home").classList.add("hidden");
    document.getElementById("history").classList.add("hidden");
    document.getElementById(tab).classList.remove("hidden");
    if(tab === "history") renderHistory();
}

async function startWorkout() {
    document.getElementById("home").classList.add("hidden");
    document.getElementById("mainNav").style.display = "none";
    document.getElementById("workoutScreen").classList.remove("hidden");
    
    const goalTitle = userData.goal === 'legs' ? "SQUATS" : "PUSH-UPS";
    document.getElementById("exerciseTitle").innerText = goalTitle;

    try {
        const link = LINKS[userData.goal];
        model = await tmPose.load(link + "model.json", link + "metadata.json");
        webcam = new tmPose.Webcam(300, 300, true);
        await webcam.setup();
        await webcam.play();
        
        ctx = document.getElementById("canvas").getContext("2d");
        document.getElementById("status-msg").innerText = "Systeem actief üü¢";
        loop();
    } catch(e) { alert("Camera fout. Gebruik HTTPS."); stopWorkout(); }
}

async function loop() {
    webcam.update();
    const { pose, posenetOutput } = await model.estimatePose(webcam.canvas);
    const prediction = await model.predict(posenetOutput);

    if (prediction[1].probability > 0.85) status = "down";
    if (prediction[0].probability > 0.85 && status === "down") {
        status = "up";
        reps++;
        document.getElementById("repCounter").innerText = reps;
    }

    ctx.drawImage(webcam.canvas, 0, 0);
    animationId = window.requestAnimationFrame(loop);
}

function stopWorkout() {
    if(webcam) webcam.stop();
    window.cancelAnimationFrame(animationId);
    location.reload(); 
}

function resetUser() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>
