<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SmartFitness Pro</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.6.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>

<style>
body{
    margin:0;
    font-family:Inter, sans-serif;
    background:#0f172a;
    color:white;
}
.container{
    max-width:500px;
    margin:auto;
    padding:20px;
}
.card{
    background:#1e293b;
    padding:20px;
    border-radius:20px;
    margin-bottom:20px;
}
button{
    width:100%;
    padding:14px;
    margin-top:10px;
    border:none;
    border-radius:12px;
    background:#22d3ee;
    font-weight:bold;
    cursor:pointer;
}
.hidden{display:none;}
.stat{
    display:flex;
    justify-content:space-between;
}
#video-box{
    margin-top:15px;
    border-radius:15px;
    overflow:hidden;
}
canvas{
    width:100%;
    transform:scaleX(-1);
}
</style>
</head>

<body>
<div class="container">

<!-- DASHBOARD -->
<div id="dashboard"></div>

<!-- SETUP -->
<div id="setup" class="hidden">
    <div class="card">
        <h2>Wat wil je trainen?</h2>
        <button onclick="setGoal('legs')">Benen</button>
        <button onclick="setGoal('chest')">Borst</button>
    </div>

    <div class="card">
        <h2>Wat is je niveau?</h2>
        <button onclick="setLevel('beginner')">Beginner</button>
        <button onclick="setLevel('advanced')">Gevorderd</button>
    </div>
</div>

<!-- WORKOUT -->
<div id="workout" class="hidden">
    <h2 id="workoutTitle"></h2>

    <div class="card stat">
        <div>Reps</div>
        <div id="repCounter">0</div>
    </div>

    <div id="video-box">
        <canvas id="canvas"></canvas>
    </div>

    <button onclick="stopWorkout()">Stop</button>
</div>

</div>

<script>
const LINKS={
    legs:"https://teachablemachine.withgoogle.com/models/Nv8j7aUsi/",
    chest:"https://teachablemachine.withgoogle.com/models/VyHCtMsZf/"
};

let model,webcam,ctx;
let reps=0,target=0;
let status="up";
let cooldown=false;
let userData={goal:null,level:null};

init();

function init(){
    const saved=localStorage.getItem("fitnessUser");
    if(saved){
        userData=JSON.parse(saved);
        showDashboard();
    }else{
        document.getElementById("setup").classList.remove("hidden");
    }
}

function setGoal(goal){
    userData.goal=goal;
}

function setLevel(level){
    userData.level=level;

    if(level==="beginner") target=8;
    else target=25;

    localStorage.setItem("fitnessUser",JSON.stringify(userData));
    showDashboard();
}

function showDashboard(){
    document.getElementById("setup").classList.add("hidden");

    let html=`
        <div class="card">
            <h2>Today's Workout</h2>
            <p>Focus: ${userData.goal}</p>
            <p>Level: ${userData.level}</p>
            <button onclick="startWorkout()">Start Workout</button>
        </div>
    `;
    document.getElementById("dashboard").innerHTML=html;
}

async function startWorkout(){
    document.getElementById("dashboard").innerHTML="";
    document.getElementById("workout").classList.remove("hidden");

    document.getElementById("workoutTitle").innerText=
        userData.goal==="legs"?"Squats":"Push-ups";

    reps=0;
    document.getElementById("repCounter").innerText=`0/${target}`;

    const link=LINKS[userData.goal];
    model=await tmPose.load(link+"model.json",link+"metadata.json");

    webcam=new tmPose.Webcam(300,300,true);
    await webcam.setup();
    await webcam.play();

    const canvas=document.getElementById("canvas");
    canvas.width=300;
    canvas.height=300;
    ctx=canvas.getContext("2d");

    requestAnimationFrame(loop);
}

async function loop(){
    webcam.update();
    await predict();
    requestAnimationFrame(loop);
}

async function predict(){
    const {posenetOutput}=await model.estimatePose(webcam.canvas);
    const prediction=await model.predict(posenetOutput);

    const upClass=prediction.find(p=>p.className==="up");
    const downClass=prediction.find(p=>p.className==="down");

    if(downClass && downClass.probability>0.9){
        status="down";
    }

    if(upClass && upClass.probability>0.9 && status==="down" && !cooldown){
        status="up";
        cooldown=true;
        setTimeout(()=>cooldown=false,500);

        reps++;
        document.getElementById("repCounter").innerText=`${reps}/${target}`;

        if(reps>=target){
            alert("Workout Complete!");
            stopWorkout();
        }
    }

    ctx.drawImage(webcam.canvas,0,0);
}

function stopWorkout(){
    if(webcam) webcam.stop();
    document.getElementById("workout").classList.add("hidden");
    showDashboard();
}
</script>

</body>
</html>
